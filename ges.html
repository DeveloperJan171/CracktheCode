<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detective Conan: Code Breaker</title>
    <style>
        :root {
            --conan-blue: #002b5e;
            --conan-red: #e60012;
            --conan-gold: #f9d71c;
            --paper-bg: #f4e4bc;
        }
        body { 
            font-family: 'Courier New', Courier, monospace; 
            background: #0a0a0a; 
            background-image: radial-gradient(circle, #1a1a1a 10%, transparent 10%), radial-gradient(circle, #1a1a1a 10%, transparent 10%);
            background-size: 20px 20px;
            color: #fff; display: flex; flex-direction: column; align-items: center; padding: 20px; 
        }
        .card { 
            background: var(--conan-blue); padding: 30px; border: 4px solid white;
            border-radius: 5px; box-shadow: 0 20px 50px rgba(0,0,0,0.7); 
            width: 95%; max-width: 480px; text-align: center; position: relative;
        }
        .card::before {
            content: "TOP SECRET"; position: absolute; top: 10px; right: -20px;
            background: var(--conan-red); color: white; padding: 5px 20px; 
            transform: rotate(15deg); font-weight: bold; font-size: 0.8rem; z-index: 10;
        }
        h1 { color: var(--conan-gold); text-transform: uppercase; margin-top: 0; }
        .turn-banner { 
            font-size: 1.2rem; padding: 15px; margin-bottom: 20px; 
            border: 2px dashed var(--conan-gold); background: rgba(0,0,0,0.3); color: var(--conan-gold);
        }
        input { 
            width: 140px; padding: 12px; font-size: 1.8rem; text-align: center; 
            letter-spacing: 5px; border: 3px solid var(--conan-gold); 
            background: #000; color: #fff; margin: 10px; 
        }
        button { 
            padding: 12px 25px; border: none; background: var(--conan-red); 
            color: white; font-weight: bold; cursor: pointer; text-transform: uppercase;
            box-shadow: 3px 3px 0px #800000;
        }
        button:disabled { background: #444 !important; box-shadow: none !important; color: #888 !important; }
        
        .history-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .log { 
            background: var(--paper-bg); color: #222; padding: 10px; height: 180px; 
            overflow-y: auto; font-size: 0.8rem; text-align: left; 
            background-image: repeating-linear-gradient(transparent, transparent 19px, #d1c19d 20px);
        }
        .hidden { display: none; }
        .force-reset { margin-top: 30px; font-size: 0.7rem; color: #888; text-decoration: underline; cursor: pointer; }
        .show-btn { background: none; box-shadow: none; color: var(--conan-gold); padding: 5px; font-size: 0.7rem; }
    </style>
</head>
<body>

<div class="card">
    <h1>Detective Agency</h1>
    
    <div id="player-select">
        <p>Identify yourself, Detective:</p>
        <button id="p1SelectBtn" onclick="tryChoosePlayer(1)">Detective 1</button>
        <button id="p2SelectBtn" onclick="tryChoosePlayer(2)" style="background:#00d4ff; color: #000;">Detective 2</button>
        <div class="force-reset" onclick="resetGame()">Room Stuck? Click here to Clear Evidence</div>
    </div>

    <div id="setup" class="hidden">
        <h3 style="color: var(--conan-gold);">Set Secret Code</h3>
        <input type="password" id="secretInput" maxlength="4" inputmode="numeric">
        <br>
        <button class="show-btn" onclick="toggleSecret()">Show/Hide Code</button>
        <br><br>
        <button onclick="lockCode()">Lock Evidence</button>
    </div>

    <div id="game" class="hidden">
        <div id="turnBanner" class="turn-banner">Analyzing...</div>
        <input type="text" id="guessInput" maxlength="4" placeholder="0000" inputmode="numeric">
        <br>
        <button id="submitBtn" onclick="submitGuess()">Deduce!</button>
        <div class="history-container">
            <div><small style="color:#00d4ff">D1 Notes</small><div id="p1Log" class="log"></div></div>
            <div><small style="color:#ff8800">D2 Notes</small><div id="p2Log" class="log"></div></div>
        </div>
        <div id="revealArea" style="margin-top:10px; color:var(--conan-gold)"></div>
        <button id="resetBtn" class="hidden" onclick="resetGame()" style="width:100%; margin-top:15px;">New Case</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBM3nlqtQ-vyiUDvZ0_D-eBSs6NMoGxqmQ",
        authDomain: "crackthecode-6c93a.firebaseapp.com",
        databaseURL: "https://crackthecode-6c93a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "crackthecode-6c93a",
        storageBucket: "crackthecode-6c93a.firebasestorage.app",
        messagingSenderId: "225093072210",
        appId: "1:225093072210:web:70db22240fdb9db5e3f68b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const gameRef = ref(db, 'game_sessions/demo'); 

    let myRole = null;
    let gameState = {};

    onValue(gameRef, (snapshot) => {
        const data = snapshot.val();
        gameState = data || {};

        if (myRole === null) {
            document.getElementById('p1SelectBtn').disabled = !!(data && data.p1Taken);
            document.getElementById('p2SelectBtn').disabled = !!(data && data.p2Taken);
            document.getElementById('p1SelectBtn').innerText = (data && data.p1Taken) ? "D1 (OCCUPIED)" : "Detective 1";
            document.getElementById('p2SelectBtn').innerText = (data && data.p2Taken) ? "D2 (OCCUPIED)" : "Detective 2";
        }

        if (!data && myRole !== null) window.location.reload();

        if (data && data.p1Ready && data.p2Ready) {
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            updateUI(data);
        }
    });

    window.tryChoosePlayer = async (num) => {
        const snap = await get(gameRef);
        const d = snap.val() || {};
        if (d[`p${num}Taken`]) return alert("Spot taken!");
        myRole = num;
        await update(gameRef, { [`p${num}Taken`]: true });
        document.getElementById('player-select').classList.add('hidden');
        document.getElementById('setup').classList.remove('hidden');
    };

    window.toggleSecret = () => {
        const x = document.getElementById("secretInput");
        x.type = (x.type === "password") ? "text" : "password";
    };

    window.lockCode = () => {
        const val = document.getElementById('secretInput').value;
        if(val.length !== 4) return alert("Enter 4 digits");
        update(gameRef, { [`p${myRole}Code`]: val, [`p${myRole}Ready`]: true, turn: 1 });
        document.getElementById('setup').innerHTML = "<h3>Locked!</h3><p>Waiting...</p>";
    };

    function updateUI(data) {
        const turn = data.turn || 1;
        const banner = document.getElementById('turnBanner');
        if (data.winner) {
            banner.innerText = (data.winner === myRole) ? "ðŸ† CASE SOLVED!" : "ðŸ’€ DEFEAT";
            document.getElementById('resetBtn').classList.remove('hidden');
            document.getElementById('revealArea').innerText = "Code was: " + (myRole === 1 ? data.p2Code : data.p1Code);
        } else {
            banner.innerText = (turn === myRole) ? "ðŸ” YOUR TURN" : "âŒ› OPPONENT...";
        }
        document.getElementById('submitBtn').disabled = (turn !== myRole || !!data.winner);
        renderLog('p1Log', data.p1Guesses);
        renderLog('p2Log', data.p2Guesses);
    }

    function renderLog(id, guesses) {
        const el = document.getElementById(id); el.innerHTML = "";
        if(!guesses) return;
        Object.values(guesses).reverse().forEach(g => {
            el.innerHTML += `<div>â€¢ <b>${g.val}</b>: ${g.score}</div>`;
        });
    }

    window.submitGuess = () => {
        const g = document.getElementById('guessInput').value;
        if(g.length !== 4) return;
        const target = (myRole === 1) ? gameState.p2Code : gameState.p1Code;
        let s = 0;
        for(let i=0; i<4; i++) if(g[i] === target[i]) s++;
        const up = { turn: (myRole === 1 ? 2 : 1) };
        if (s === 4) up.winner = myRole;
        update(gameRef, up);
        set(ref(db, `game_sessions/demo/p${myRole}Guesses/${Date.now()}`), { val: g, score: s });
        document.getElementById('guessInput').value = "";
    };

    window.resetGame = () => remove(gameRef).then(() => window.location.reload());
</script>
</body>
</html>
